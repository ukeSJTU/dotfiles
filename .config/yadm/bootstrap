#!/bin/bash

set -e

echo "==> Starting bootstrap process..."

# Detect OS
detect_os() {
    case "$(uname -s)" in
        Darwin*)
            echo "macos"
            ;;
        Linux*)
            echo "linux"
            ;;
        MINGW*|MSYS*|CYGWIN*)
            echo "windows"
            ;;
        *)
            echo "unknown"
            ;;
    esac
}

OS=$(detect_os)
echo "==> Detected OS: $OS"

# Install Starship (cross-platform)
if command -v starship &> /dev/null; then
    echo "==> Starship already installed ($(starship --version))"
else
    echo "==> Installing Starship..."
    if [ "$OS" = "windows" ]; then
        # Use winget or scoop if available, otherwise manual install
        if command -v winget &> /dev/null; then
            winget install --id Starship.Starship -e
        elif command -v scoop &> /dev/null; then
            scoop install starship
        else
            echo "Please install Starship manually from https://starship.rs/"
        fi
    else
        curl -sS https://starship.rs/install.sh | sh -s -- -y
    fi
    echo "==> Starship installed!"
fi

# Install mise (cross-platform)
if command -v mise &> /dev/null; then
    echo "==> mise already installed ($(mise --version))"
else
    echo "==> Installing mise..."
    if [ "$OS" = "windows" ]; then
        # For Windows, use installer or scoop
        if command -v scoop &> /dev/null; then
            scoop install mise
        else
            echo "Please install mise manually from https://mise.jdx.dev/"
            echo "Recommended: scoop install mise"
        fi
    else
        curl https://mise.run | sh
    fi
fi

# Install global tools via mise
echo "==> Installing global tools via mise..."
if command -v mise &> /dev/null; then
    mise install
else
    echo "Warning: mise not found, skipping tool installation"
fi

# Platform-specific package manager setup
case "$OS" in
    macos)
        echo "==> macOS detected - Installing Homebrew packages..."
        if ! command -v brew &> /dev/null; then
            echo "==> Installing Homebrew..."
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        fi
        
        if [ -f "$HOME/.Brewfile" ]; then
            echo "==> Running brew bundle..."
            brew bundle --global
        else
            echo "Warning: .Brewfile not found"
        fi
        ;;
    
    windows)
        echo "==> Windows detected - Installing packages..."
        
        # Check for Scoop
        if ! command -v scoop &> /dev/null; then
            echo "==> Scoop not found. Installing Scoop..."
            echo "Please run this in PowerShell:"
            echo "Set-ExecutionPolicy RemoteSigned -Scope CurrentUser"
            echo "irm get.scoop.sh | iex"
            echo ""
            echo "Then run 'yadm bootstrap' again"
        else
            echo "==> Scoop found, installing packages..."
            
            # Add recommended buckets
            scoop bucket add extras 2>/dev/null || true
            scoop bucket add nerd-fonts 2>/dev/null || true
            
            # Install from Scoopfile if it exists
            if [ -f "$HOME/.Scoopfile" ]; then
                echo "==> Installing from Scoopfile..."
                while IFS= read -r package; do
                    # Skip comments (with or without leading spaces) and empty/whitespace-only lines
                    package_trimmed=$(echo "$package" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
                    [[ "$package_trimmed" =~ ^#.*$ ]] || [[ -z "$package_trimmed" ]] && continue
                    echo "Installing: $package_trimmed"
                    scoop install "$package_trimmed" || true
                done < "$HOME/.Scoopfile"
            fi
        fi
        
        # Check for winget as alternative
        if command -v winget &> /dev/null && [ ! -f "$HOME/.Scoopfile" ]; then
            echo "==> winget found. You can use winget for package management."
            echo "Create a .Scoopfile or use winget import/export"
        fi
        ;;
    
    linux)
        echo "==> Linux detected"
        echo "==> Package management varies by distribution"
        echo "==> Please install packages manually or add distribution-specific logic"
        
        # Detect Linux distribution
        if [ -f /etc/os-release ]; then
            . /etc/os-release
            echo "==> Detected distribution: $NAME"
            
            case "$ID" in
                ubuntu|debian)
                    echo "==> Use: apt install <package>"
                    ;;
                fedora|rhel|centos)
                    echo "==> Use: dnf install <package>"
                    ;;
                arch|manjaro)
                    echo "==> Use: pacman -S <package>"
                    ;;
            esac
        fi
        ;;
esac

echo ""
echo "==> Bootstrap complete!"
echo "==> Next steps:"
echo "    1. Restart your shell or run: source ~/.zshrc (Unix) or source ~/.bashrc"
echo "    2. Verify installations: mise list, starship --version"
echo "    3. Configure your shell and tools as needed"
